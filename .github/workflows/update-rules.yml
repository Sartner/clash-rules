# =============================================================================
# GitHub Action - Clash Rules è‡ªåŠ¨æ›´æ–°å·¥ä½œæµ
# =============================================================================
# æ¯å¤©å‡Œæ™¨4ç‚¹è‡ªåŠ¨æ£€æŸ¥å¹¶æ›´æ–°è§„åˆ™æ–‡ä»¶
# å¦‚æœMD5å€¼å‘ç”Ÿå˜åŒ–ï¼Œåˆ™æäº¤æ–°ç‰ˆæœ¬
# =============================================================================

name: æ›´æ–°è§„åˆ™æ–‡ä»¶

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨4ç‚¹ï¼ˆUTC 20:00ï¼‰è‡ªåŠ¨è§¦å‘
  schedule:
    - cron: '0 20 * * *'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥MD5æ£€æŸ¥ï¼‰'
        required: false
        default: 'false'
        type: boolean

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹ï¼ˆç”¨äºæäº¤æ›´æ”¹ï¼‰
  # ä¸ªäººé¡¹ç›®ç›´æ¥æ¨é€åˆ°ä¸»åˆ†æ”¯ï¼Œæ— éœ€PR

jobs:
  update-rules:
    runs-on: ubuntu-latest

    env:
      PYTHON_VERSION: '3.9'
      SCRIPTS_DIR: scripts
      OUTPUT_DIR: scripts  # è¾“å‡ºåˆ°scriptsç›®å½•

    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºè®¡ç®—MD5

      # è®¾ç½®Pythonç¯å¢ƒ
      - name: è®¾ç½®Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # ç¼“å­˜pipä¾èµ–
      - name: ç¼“å­˜pipä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', 'scripts/merge_rules.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # å®‰è£…ä¾èµ–
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML requests

      # ä¸‹è½½è¿œç¨‹è§„åˆ™å¹¶è®¡ç®—MD5
      - name: ç”Ÿæˆè§„åˆ™æ–‡ä»¶
        id: generate
        run: |
          echo "ğŸ• å¼€å§‹ç”Ÿæˆè§„åˆ™æ–‡ä»¶..."
          cd scripts

          # åŠ¨æ€è·å–è¾“å‡ºæ–‡ä»¶åˆ—è¡¨
          OUTPUT_FILES=$(python3 -c "
          import yaml
          with open('config.yaml', 'r') as f:
              config = yaml.safe_load(f)
              files = [group.get('output', '') for group in config.get('rule_groups', [])]
              print(' '.join(files))
          ")
          echo "è¾“å‡ºæ–‡ä»¶åˆ—è¡¨: $OUTPUT_FILES"

          # è¿è¡Œè„šæœ¬ç”Ÿæˆè§„åˆ™ï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
          if ! python merge_rules.py --config config.yaml; then
            echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥"
            exit 1
          fi

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          for file in $OUTPUT_FILES; do
            if [ ! -f "$file" ]; then
              echo "âŒ æ–‡ä»¶ $file æœªç”Ÿæˆ"
              exit 1
            fi
          done

          # è®¡ç®—æ–°ç”Ÿæˆæ–‡ä»¶çš„MD5å€¼
          echo "ğŸ“Š è®¡ç®—MD5å€¼..."
          MD5_SUM=""
          for file in $OUTPUT_FILES; do
            if [ -f "$file" ]; then
              MD5=$(md5sum "$file" | awk '{print $1}')
              MD5_SUM="${MD5_SUM}${file}:${MD5} "
              echo "   $file: $MD5"
            fi
          done

          # ä¿å­˜åˆ°GitHubç¯å¢ƒå˜é‡
          echo "md5_summary=$MD5_SUM" >> $GITHUB_OUTPUT

          echo "âœ… MD5è®¡ç®—å®Œæˆ"

      # è·å–ä¸Šæ¬¡æäº¤çš„MD5å€¼
      - name: è·å–ä¸Šæ¬¡æäº¤çš„MD5å€¼
        id: previous
        run: |
          # è·å–ä¸Šæ¬¡æäº¤ä¸­å¯¹åº”çš„æ–‡ä»¶
          PREV_COMMIT=$(git rev-parse HEAD~1 2>/dev/null || echo "HEAD~1 does not exist")

          echo "ğŸ“– ä¸Šæ¬¡æäº¤: $PREV_COMMIT"

          # åŠ¨æ€è·å–è¾“å‡ºæ–‡ä»¶åˆ—è¡¨
          OUTPUT_FILES=$(python3 -c "
          import yaml
          with open('scripts/config.yaml', 'r') as f:
              config = yaml.safe_load(f)
              files = [group.get('output', '') for group in config.get('rule_groups', [])]
              print(' '.join(files))
          ")

          # æå–æ–‡ä»¶åï¼ˆå»æ‰è·¯å¾„ï¼‰
          BASENAME_FILES=$(echo $OUTPUT_FILES | sed 's|../rules/||g')

          # è®¡ç®—ä¸Šæ¬¡æäº¤çš„MD5æ‘˜è¦
          PREV_MD5_SUM=""
          for file in $OUTPUT_FILES; do
            # æå–æ–‡ä»¶åå‰ç¼€
            filename=$(basename "$file")
            if git show $PREV_COMMIT:rules/$filename > /tmp/prev_$filename 2>/dev/null; then
              PREV_MD5=$(md5sum /tmp/prev_$filename | awk '{print $1}')
              PREV_MD5_SUM="${PREV_MD5_SUM}${file}:${PREV_MD5} "
              echo "ä¸Šæ¬¡ $filename MD5: $PREV_MD5"
            else
              echo "âš ï¸  æœªæ‰¾åˆ°ä¸Šæ¬¡æäº¤çš„ $filename æ–‡ä»¶"
            fi
          done

          echo "prev_md5_summary=$PREV_MD5_SUM" >> $GITHUB_OUTPUT

      # æ¯”è¾ƒMD5å¹¶å†³å®šæ˜¯å¦éœ€è¦æäº¤
      - name: æ£€æŸ¥MD5å˜åŒ–
        id: check
        run: |
          NEW_MD5="${{ steps.generate.outputs.md5_summary }}"
          PREV_MD5="${{ steps.previous.outputs.prev_md5_summary }}"

          echo "æ–°MD5æ‘˜è¦: $NEW_MD5"
          echo "ä¸Šæ¬¡MD5æ‘˜è¦: $PREV_MD5"

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          CHANGED=0

          if [ "$NEW_MD5" != "$PREV_MD5" ]; then
            echo "ğŸ”„ æ£€æµ‹åˆ°æ–‡ä»¶å‘ç”Ÿå˜åŒ–"
            CHANGED=1
          else
            echo "âœ… æ‰€æœ‰æ–‡ä»¶MD5æœªå˜åŒ–ï¼Œæ— éœ€æ›´æ–°"
          fi

          # å¦‚æœæ˜¯å¼ºåˆ¶æ›´æ–°æ¨¡å¼
          FORCE_UPDATE="${{ github.event.inputs.force_update }}"
          if [ "$FORCE_UPDATE" = "true" ]; then
            echo "âš¡ å¼ºåˆ¶æ›´æ–°æ¨¡å¼å¯ç”¨"
            CHANGED=1
          fi

          # è¾“å‡ºç»“æœ
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

          if [ $CHANGED -eq 0 ]; then
            echo "âœ… æ— éœ€æ›´æ–°"
          else
            echo "ğŸ“ å‡†å¤‡æäº¤"
          fi

      # é…ç½®Gitï¼ˆä»…åœ¨éœ€è¦æäº¤æ—¶ï¼‰
      - name: é…ç½®Git
        if: steps.check.outputs.changed == '1'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # æäº¤å¹¶æ¨é€æ›´æ”¹
      - name: æäº¤æ›´æ”¹
        if: steps.check.outputs.changed == '1'
        run: |
          cd scripts

          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          git add .

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
            exit 0
          fi

          # æäº¤æ›´æ”¹
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          MD5_SUMMARY="${{ steps.generate.outputs.md5_summary }}"

          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°è§„åˆ™æ–‡ä»¶ - $TIMESTAMP

          æ›´æ–°è¯¦æƒ…: $MD5_SUMMARY

          [skip ci]" || echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"

      # æ¨é€åˆ°ä»“åº“
      - name: æ¨é€åˆ°ä¸»åˆ†æ”¯
        if: steps.check.outputs.changed == '1'
        run: |
          git push origin main

      # æ€»ç»“
      - name: æ€»ç»“
        run: |
          echo "=== ğŸ“Š æ›´æ–°å®Œæˆ ==="
          echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "å˜æ›´: ${{ steps.check.outputs.changed == '1' && 'æ˜¯' || 'å¦' }}"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "æäº¤: ${{ github.sha }}"
